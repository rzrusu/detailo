version: '3.8'

# 1. TOP-LEVEL SERVICES
services:

  # --- Eureka Server Service ---
  eureka-server:
    build:
      context: ./eureka-server
    container_name: eureka-server
    ports:
      - "8761:8761"
    networks:
      - detailo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 20s

  # --- Config Server Service ---
  config-server:
    build:
      context: ./config-server
    container_name: config-server
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=native
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_CLOUD_CONFIG_SERVER_NATIVE_SEARCHLOCATIONS=file:///config-repo
    volumes:
      - ${CONFIG_REPO:-./config-repo}:/config-repo
    depends_on:
      eureka-server:
        condition: service_healthy
    networks:
      - detailo-network
    # --- ADD THIS HEALTHCHECK ---
    healthcheck:
      # Use curl to check the /actuator/health endpoint
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 10s   # Check every 10 seconds
      timeout: 5s     # Wait 5 seconds for a response
      retries: 5      # Try 5 times before failing
      start_period: 20s # Give it 20 seconds to start up before checking

  # --- PostgreSQL Database Service ---
  postgres-db:
    image: postgres:15-alpine
    container_name: postgres-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=identity_db
    ports:
      - "5432:5432"
    networks:
      - detailo-network
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d identity_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # --- Identity Service ---
  identity-service:
    build:
      context: .
      dockerfile: ./identity-service/Dockerfile
    container_name: identity-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CLOUD_CONFIG_URI=http://config-server:8888
      - EUREKA_DEFAULT_ZONE=http://eureka-server:8761/eureka/
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka-server:8761/eureka/
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-db:5432/identity_db
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=postgres
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.postgresql.Driver
      - DETAILO_OAUTH_CLIENT_SECRET=${DETAILO_OAUTH_CLIENT_SECRET}
    networks:
      - detailo-network
    # --- UPDATED DEPENDS_ON ---
    depends_on:
      postgres-db:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
      config-server:
        condition: service_healthy # Wait for healthcheck to pass

# 2. TOP-LEVEL NETWORKS
networks:
  detailo-network:
    driver: bridge

# 3. TOP-LEVEL VOLUMES
volumes:
  postgres_data:
    driver: local